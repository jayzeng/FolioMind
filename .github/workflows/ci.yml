name: iOS CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SCHEME: FolioMind
  XCODE_VERSION: "16.1"

jobs:
  lint:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Lint Swift sources
        run: swiftlint lint --config .swiftlint.yml --reporter github-actions-logging

  build-and-test:
    runs-on: macos-15
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - name: Create simulator for CI
        run: |
          python3 - <<'PY'
          import json
          import os
          import subprocess
          import sys
          import re

          def run_json(cmd):
              return json.loads(subprocess.check_output(cmd, text=True))

          def version_tuple(rt):
              ident = rt.get("identifier", "")
              match = re.search(r"iOS-([0-9][0-9\-]*)", ident)
              if match:
                  parts = match.group(1).split("-")
                  return tuple(int(p) for p in parts if p.isdigit())
              version = rt.get("version", "")
              return tuple(int(p) for p in re.findall(r"\d+", version))

          def version_string(rt):
              parts = version_tuple(rt)
              return ".".join(str(p) for p in parts) if parts else rt.get("version", "latest")

          runtimes = run_json(["xcrun", "simctl", "list", "runtimes", "--json"]).get("runtimes", [])
          ios_runtimes = [
              r for r in runtimes
              if r.get("platform") == "iOS"
              and r.get("isAvailable", True)
              and "iOS-" in r.get("identifier", "")
          ]
          if not ios_runtimes:
              print("No iOS simulator runtime is available on this runner.")
              subprocess.run(["xcrun", "simctl", "list", "runtimes"])
              sys.exit(1)

          ios_runtimes.sort(key=version_tuple, reverse=True)
          chosen_runtime = ios_runtimes[0]
          runtime_id = chosen_runtime["identifier"]
          runtime_version = version_string(chosen_runtime)

          devicetypes = run_json(["xcrun", "simctl", "list", "devicetypes", "--json"]).get("devicetypes", [])
          available_devices = [
              d for d in devicetypes
              if d.get("isAvailable", True) and "(unavailable)" not in d.get("availability", "").lower()
          ]
          preferred = next((d for d in available_devices if "iPhone 15" in d.get("name", "")), None)
          if preferred is None:
              iphones = [d for d in available_devices if "iPhone" in d.get("name", "")]
              if not iphones:
                  print("No available iPhone device types found.")
                  sys.exit(1)
              iphones.sort(key=lambda d: d.get("name", ""), reverse=True)
              preferred = iphones[0]

          device_type_id = preferred["identifier"]
          device_name = "CI-iPhone-15"

          subprocess.run(["xcrun", "simctl", "delete", device_name], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
          subprocess.check_call(["xcrun", "simctl", "create", device_name, device_type_id, runtime_id])

          devices_json = run_json(["xcrun", "simctl", "list", "devices", "--json"]).get("devices", {})
          detected_os = runtime_version
          for rt_key, devices in devices_json.items():
              if any(dev.get("name") == device_name for dev in devices):
                  match = re.search(r"iOS-([0-9][0-9\-]*)", rt_key)
                  if match:
                      detected_os = match.group(1).replace("-", ".")
                  break

          dest_line = f"DESTINATION=platform=iOS Simulator,OS={detected_os},name={device_name}"
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env_file:
              env_file.write(dest_line + "\n")
          print(dest_line)
          PY

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Resolve Swift package dependencies
        run: xcodebuild -resolvePackageDependencies -scheme "$SCHEME"

      - name: Build
        run: xcodebuild -scheme "$SCHEME" -destination "$DESTINATION" clean build

      - name: Test
        run: xcodebuild test -scheme "$SCHEME" -destination "$DESTINATION" -enableCodeCoverage YES
